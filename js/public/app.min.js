!function(n,e,o,i,r){"use strict";var s=n.module("Notes",["restangular","ngRoute"]).config(["$provide","$routeProvider","RestangularProvider","$httpProvider","$windowProvider",function(t,n,e,i,r){i.defaults.headers.common.requesttoken=o,t.value("Constants",{saveInterval:5e3}),n.when("/notes/:noteId",{templateUrl:"note.html",controller:"NoteController",resolve:{note:["$route","$q","is","Restangular",function(t,n,e,o){var i=n.defer(),r=t.current.params.noteId;return e.loading=!0,o.one("notes",r).get().then(function(t){e.loading=!1,i.resolve(t)},function(){e.loading=!1,i.reject()}),i.promise}]}}).otherwise({redirectTo:"/"});var s=r.$get(),u=s.location.href,a=u.split("index.php")[0]+"index.php/apps/notes";e.setBaseUrl(a)}]).run(["$rootScope","$location","NotesModel",function(t,n,o){e('link[rel="shortcut icon"]').attr("href",OC.filePath("notes","img","favicon.png")),t.$on("$routeChangeError",function(){var t=o.getAll();if(t.length>0){var e=t.sort(function(t,n){return t.modified>n.modified?1:t.modified<n.modified?-1:0}),i=t[e.length-1];n.path("/notes/"+i.id)}else n.path("/")})}]);s.controller("AppController",["$scope","$location","is",function(t,n,e){t.is=e,t.init=function(t){0!==t&&n.path("/notes/"+t)},t.writebyHand=function(){t.$broadcast("useHandWriting")}}]),s.controller("NoteController",["$routeParams","$scope","NotesModel","SaveQueue","note",function(n,o,i,r,s){i.updateIfExists(s),o.note=i.get(n.noteId),console.log(o.note),o.isSaving=function(){return r.isSaving()},o.updateTitle=function(){o.note.title=o.note.content.split("\n")[0]||t("notes","New note")},o.save=function(){o.note.handwrittenContent=e(".kbw-signature").signature("toJSON");var t=o.note;r.add(t)}}]),s.controller("NotesController",["$routeParams","$scope","$location","Restangular","NotesModel",function(t,n,e,o,i){n.route=t,n.notes=i.getAll();var r=o.all("notes");r.getList().then(function(t){i.addAll(t)}),n.create=function(){r.post().then(function(t){i.add(t),e.path("/notes/"+t.id)})},n["delete"]=function(t){var e=i.get(t);e.remove().then(function(){i.remove(t),n.$emit("$routeChangeError")})}}]),s.directive("notesAutofocus",function(){return{restrict:"A",link:function(t,n){n.focus()}}}),s.directive("editor",["$timeout",function(t){return{restrict:"A",link:function(n,o){var r=i(o[0],{change:function(e){t(function(){n.$apply(function(){n.note.content=e,n.updateTitle()})})}});r.setValue(n.note.content),o.on("click",".link",function(t){if(t.ctrlKey){var n=e(this).find(".link-params-inner").text();window.open(n,"_blank")}})}}}]),s.directive("handwritten",[function(){return{restrict:"A",link:function(t,n){console.log(JSON.stringify(n)),e(n).signature({change:function(n,e){t.save()}}),e(n).signature("disable"),""!=t.note.handwrittenContent&&e(n).signature("draw",t.note.handwrittenContent),t.$on("useHandWriting",function(t){e(n).signature("enable")})}}}]),s.directive("notesIsSaving",["$window",function(n){return{restrict:"A",scope:{notesIsSaving:"="},link:function(e){n.onbeforeunload=function(){return e.notesIsSaving?t("notes","Note is currently saving. Leaving the page will delete all changes!"):null}}}}]),s.directive("notesTimeoutChange",["$timeout",function(t){return{restrict:"A",link:function(n,o,i){var r,s=300;e(o).bind("input propertychange paste",function(){t.cancel(r),r=t(function(){n.$apply(i.notesTimeoutChange)},s)})}}}]),s.directive("notesTooltip",function(){return{restrict:"A",link:function(t,n){n.tooltip()}}}),s.filter("noteTitle",function(){return function(t){return t=t.split("\n")[0]||"newNote",t.trim().replace(/^#+/g,"")}}),s.filter("wordCount",function(){return function(t){if(t&&"string"==typeof t){var n=t.split(/\s+/).filter(function(t){return-1!==t.search(/[A-Za-z0-9]/)}).length;return window.n("notes","%n word","%n words",n)}return 0}}),s.factory("is",function(){return{loading:!1}}),s.factory("NotesModel",function(){var t=function(){this.notes=[],this.notesIds={}};return t.prototype={addAll:function(t){for(var n=0;n<t.length;n+=1)this.add(t[n])},add:function(t){this.updateIfExists(t)},getAll:function(){return this.notes},get:function(t){return this.notesIds[t]},updateIfExists:function(t){var e=this.notesIds[t.id];n.isDefined(e)?(e.title=t.title,e.modified=t.modified,e.content=t.content,e.handwrittenContent=t.handwrittenContent):(this.notes.push(t),this.notesIds[t.id]=t)},remove:function(t){for(var n=0;n<this.notes.length;n+=1){var e=this.notes[n];if(e.id===t){this.notes.splice(n,1),delete this.notesIds[t];break}}}},new t}),s.factory("SaveQueue",["$q",function(t){var n=function(){this._queue={},this._flushLock=!1};return n.prototype={add:function(t){this._queue[t.id]=t,this._flush()},_flush:function(){var n=Object.keys(this._queue);if(0!==n.length&&!this._flushLock){this._flushLock=!0;for(var e=this,o=[],i=0;i<n.length;i+=1){var r=this._queue[n[i]];o.push(r.put().then(this._noteUpdateRequest.bind(null,r)))}this._queue={},t.all(o).then(function(){e._flushLock=!1,e._flush()})}},_noteUpdateRequest:function(t,n){t.title=n.title,t.modified=n.modified},isSaving:function(){return this._flushLock}},new n}])}(angular,jQuery,oc_requesttoken,mdEdit);
//# sourceMappingURL=app.min.js.map
